<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <script>
        (function () {
            'use strict';

            // record last user interaction (helpful to correlate with navigation)
            const last = { ev: null, stack: null, t: 0 };
            ['click', 'keydown', 'submit'].forEach(evt =>
                document.addEventListener(evt, (e) => {
                    try {
                        last.ev = { type: e.type, target: (e.target && (e.target.id || e.target.tagName)) || String(e.target) };
                        last.stack = (new Error()).stack;
                        last.t = Date.now();
                    } catch (ex) { /* ignore */ }
                }, { capture: true, passive: true })
            );

            function pathOf(u) {
                try { return new URL(u, location.href).pathname; } catch (e) { return ''; }
            }

            function logAndBlock(u, via) {
                try {
                    console.warn('[NAV-TRACE] blocked navigation to', u, 'via', via, { last });
                    console.warn('[NAV-TRACE] current stack:', (new Error()).stack);
                    // break into debugger so you can inspect callers
                    debugger;
                } catch (e) { /* ignore */ }
            }

            // patch common programmatic navigation points
            try {
                const _assign = window.location.assign.bind(window.location);
                window.location.assign = function (u) {
                    if (pathOf(u) === '/api/login') { logAndBlock(u, 'location.assign'); return; }
                    return _assign(u);
                };
            } catch (e) { /* ignore */ }

            try {
                const _replace = window.location.replace.bind(window.location);
                window.location.replace = function (u) {
                    if (pathOf(u) === '/api/login') { logAndBlock(u, 'location.replace'); return; }
                    return _replace(u);
                };
            } catch (e) { /* ignore */ }

            try {
                const _push = history.pushState.bind(history);
                history.pushState = function (state, title, url) {
                    if (pathOf(url) === '/api/login') { logAndBlock(url, 'history.pushState'); return; }
                    return _push(state, title, url);
                };
            } catch (e) { /* ignore */ }

            try {
                const _open = window.open.bind(window);
                window.open = function (url, ...rest) {
                    if (pathOf(url) === '/api/login') { logAndBlock(url, 'window.open'); return null; }
                    return _open(url, ...rest);
                };
            } catch (e) { /* ignore */ }

            // helpful additional logging: capture anchor clicks (should already be captured by your guard)
            document.addEventListener('click', (e) => {
                try {
                    const a = e.target.closest && e.target.closest('a[href]');
                    if (!a) return;
                    const p = pathOf(a.getAttribute('href') || '');
                    if (p === '/api/login') {
                        console.warn('[NAV-TRACE] anchor click to /api/login blocked', { anchor: a, last });
                        e.preventDefault();
                        e.stopPropagation();
                        debugger;
                    }
                } catch (ex) { /* ignore */ }
            }, { capture: true, passive: false });

        })();
    </script>
    <meta charset="utf-8" />
    <title>SetlistGPT</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" th:href="@{/styles.css}" href="/styles.css" />
</head>
<body>
<header>
    <h1>SetlistGPT</h1>

    <!-- Admin button shown only for admins (Thymeleaf reads session attribute "profile") -->
    <button id="adminBtn" type="button" class="btn"
            th:if="${session.profile != null and session.profile.type == T(dk.ek.setlistgpt.profile.ProfileType).ADMIN}"
            onclick="window.location.href='/admin'">Admin</button>
</header>

<section id="publicView">
    <p class="meta">Choose an action below.</p>

    <!-- Home actions (default) -->
    <div class="actions" id="publicHomeActions">
        <button id="createProfileBtn" type="button">Create Profile</button>
        <button id="showLoginBtn" type="button">Login</button>
        <button id="seePublicBtn" type="button">See Public Repertoires &amp; Setlists</button>
    </div>

    <!-- Public browser (shown after See Public...) -->
    <div class="actions hidden" id="publicBrowseActions">
        <button id="publicRepertoiresBtn" type="button">Public Repertoires</button>
        <button id="publicSetlistsBtn" type="button">Public Setlists</button>
        <button id="backToPublicBtn" type="button">Back</button>
    </div>

    <div id="loginArea" class="hidden">
    <!-- Neutralize native navigation: action="#" prevents the browser from navigating -->
        <form id="loginForm" action="#" method="post" onsubmit="event.preventDefault();">
            <label>Username <input id="username" name="name" type="text" autocomplete="username"></label>
            <label>Password <input id="password" name="password" type="password" autocomplete="current-password"></label>
            <button id="loginBtn" type="button">Sign in</button>
            <span class="meta" aria-live="polite"></span>
        </form>
    </div>

    <div id="publicStatus" class="meta" aria-live="polite"></div>
    <div id="publicResults"></div>
</section>

<section id="authView" class="hidden">
    <p class="meta">Choose an action below.</p>
    <div class="actions">
        <button id="newRepertoireBtn" type="button">New Repertoire</button>
        <button id="myRepertoiresBtn" type="button">My Repertoires</button>
        <button id="newSetlistBtn" type="button">New Setlist</button>
        <button id="setlistsBtn" type="button">My Setlists</button>
        <button id="logoutBtn" type="button">Logout</button>
    </div>
    <div id="contentArea"></div>
</section>

<footer>
    <p>&copy; SetlistGPT</p>
</footer>

<script defer src="/javascript/login-hotfix.js"></script>
<script defer src="/javascript/frontpage.js"></script>
<script th:src="@{/javascript/create-profile.js(v=3)}" src="/javascript/create-profile.js?v=3" defer></script>
</body>
</html>